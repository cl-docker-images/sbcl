#! /bin/sh

set -e

case "$(cat /etc/apk/arch)" in
    armv7) SBCL_ARCH=arm;;
    aarch64) SBCL_ARCH=arm64;;
    x86_64) SBCL_ARCH=x86-64;;
    *) echo "Unknown arch" >&2; exit 1;;
esac

export SBCL_ARCH

SBCL_SOURCE_LOCATION=/usr/local/src/sbcl-${SBCL_VERSION}
PATCHES_LOCATION=${SBCL_SOURCE_LOCATION}/patches

cd "${SBCL_SOURCE_LOCATION}"

if [ -d "${PATCHES_LOCATION}" ]; then
    for p in "${PATCHES_LOCATION}"/*.patch; do
        [ -e "$p" ] || continue
        patch -p1 < "$p"
    done
fi

sh make.sh "$@"
sh install.sh

rm -f /usr/local/bin/sbcl.old /usr/local/lib/sbcl/sbcl.core.old
